!function(e){function t(t){for(var r,o,i=t[0],s=t[1],l=t[2],d=0,f=[];d<i.length;d++)o=i[d],Object.prototype.hasOwnProperty.call(a,o)&&a[o]&&f.push(a[o][0]),a[o]=0;for(r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r]);for(u&&u(t);f.length;)f.shift()();return c.push.apply(c,l||[]),n()}function n(){for(var e,t=0;t<c.length;t++){for(var n=c[t],r=!0,i=1;i<n.length;i++){var s=n[i];0!==a[s]&&(r=!1)}r&&(c.splice(t--,1),e=o(o.s=n[0]))}return e}var r={},a={0:0},c=[];function o(t){if(r[t])return r[t].exports;var n=r[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,o),n.l=!0,n.exports}o.m=e,o.c=r,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="";var i=window.webpackJsonp=window.webpackJsonp||[],s=i.push.bind(i);i.push=t,i=i.slice();for(var l=0;l<i.length;l++)t(i[l]);var u=s;c.push([62,1]),n()}({11:function(e,t,n){"use strict";(function(e){n.d(t,"g",(function(){return o}));var r=n(46),a=n(19),c=n(27);n(12);n.d(t,"a",(function(){return c.a})),n.d(t,"b",(function(){return c.b})),n.d(t,"c",(function(){return c.c})),n.d(t,"d",(function(){return c.d})),n.d(t,"e",(function(){return c.e})),n.d(t,"f",(function(){return c.f})),n.d(t,"h",(function(){return c.g})),n.d(t,"i",(function(){return c.h})),n.d(t,"j",(function(){return c.i}));class o{constructor(t){this.events=new r.EventEmitter,this.handleValueChanged=t=>{const n=t.target;this.emitBlock(e.from(n.value.buffer))},this.device=t,t.addEventListener("gattserverdisconnected",()=>{this.events.emit("disconnected")})}static async requestDevice(){const e=await navigator.bluetooth.requestDevice({filters:[{services:[30326]}],optionalServices:[a.b]});return new o(e)}async connect(){var e;if(this.server=await(null===(e=this.device.gatt)||void 0===e?void 0:e.connect()),void 0===this.server)return;const t=await this.server.getPrimaryService(a.b),n=await t.getCharacteristic(a.c);n.addEventListener("characteristicvaluechanged",this.handleValueChanged),await n.startNotifications()}async disconnect(){var e;try{null===(e=this.device.gatt)||void 0===e||e.disconnect()}catch(e){}this.events.removeAllListeners()}async sendCommand(e){var t;const n=await(null===(t=this.server)||void 0===t?void 0:t.getPrimaryService(a.b));if(void 0===n)return;const r=await n.getCharacteristic(a.a);await r.writeValue(e)}on(e,t){return this.events.on(e,t),()=>{this.events.off(e,t)}}emitBlock(e){try{const t=Object(c.j)(e);void 0===t?this.events.emit("failed",e):this.events.emit("packet",t)}catch(t){this.events.emit("failed",e)}}}}).call(this,n(39).Buffer)},12:function(e,t,n){"use strict";(function(e){n.d(t,"g",(function(){return a})),n.d(t,"d",(function(){return c})),n.d(t,"e",(function(){return o})),n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s})),n.d(t,"c",(function(){return l})),n.d(t,"f",(function(){return u}));var r=n(48);function a(){return d(1)}function c(t){return d(8,e.of(0,t))}function o(t=new Date){const n=e.alloc(4);return n.writeUInt32BE(Math.trunc(t.getTime()/1e3)),d(9,n)}function i(){return d(10)}function s(){return d(11)}function l(t){return d(22,e.of(t?1:0))}function u(t){return d(16,e.from([t,0,0,0,0]))}function d(t,n=e.of()){const a=e.of(170,t,...n);return e.of(...a,255&r.a.sum(a))}}).call(this,n(39).Buffer)},19:function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a})),n.d(t,"c",(function(){return c}));const r="6e400001-b5a3-f393-e0a9-e50e24dcca9e",a="6e400002-b5a3-f393-e0a9-e50e24dcca9e",c="6e400003-b5a3-f393-e0a9-e50e24dcca9e"},27:function(e,t,n){"use strict";n.d(t,"g",(function(){return a})),n.d(t,"d",(function(){return c})),n.d(t,"b",(function(){return o})),n.d(t,"i",(function(){return i})),n.d(t,"a",(function(){return s})),n.d(t,"e",(function(){return l})),n.d(t,"f",(function(){return u})),n.d(t,"c",(function(){return d})),n.d(t,"h",(function(){return f})),n.d(t,"j",(function(){return b}));var r=n(48);class a{constructor(e){m(e,1)}}class c{constructor(e){m(e,10)}}class o{constructor(e){m(e,11),this.pm25=e.readUInt16BE(2),this.recordDate=new Date(1e3*e.readUInt32BE(6))}}class i{constructor(e){m(e,80),this.windSpeed=e.readUInt8(5),Object.freeze(this),Object.seal(this)}}class s{constructor(e){m(e,80),this.capacity=e.readUInt8(3),this.isCharging=Boolean(e.readUInt8(6)),Object.freeze(this),Object.seal(this)}}class l{constructor(e){m(e,80),this.runtime=e.readUInt32BE(3),this.boottime=e.readUInt32BE(7),Object.freeze(this),Object.seal(this)}}class u{constructor(e){m(e,80),this.pm25=e.readUInt16BE(3),this.currentPm25=e.readUInt16BE(5),this.recordDate=new Date(1e3*e.readUInt32BE(7)),this.currentDate=new Date(1e3*e.readUInt32BE(12)),Object.freeze(this),Object.seal(this)}}class d{constructor(e){m(e,80),this.interval=e.readUInt16BE(3),this.enabled=Boolean(e.readUInt8(5)),Object.freeze(this),Object.seal(this)}}class f{constructor(e){m(e,84),this.minor=e.readUInt16BE(2),this.major=e.readUInt16BE(4),Object.freeze(this),Object.seal(this)}toString(){return`${this.major}.${this.minor}`}}function m(e,t){if(170!==e[0])throw new Error("unexpected header");if(e[1]!==t)throw new Error("unexpected type");if(e[e.length-1]!==(255&r.a.sum(e.slice(0,-1))))throw new Error("unexpected checksum")}const h={aa01:a,aa08:class extends c{constructor(e){super(e),this.enabled=!!e.readUInt8(2)}},aa09:class extends c{constructor(e){super(e),this.off=!!e.readUInt8(2)}},aa0a:c,aa0b:o,aa16:class{constructor(e){m(e,22),this.enabled=Boolean(e.readUInt8(2))}},aa5001:i,aa5004:s,aa5005:l,aa5006:u,aa5007:d,aa54:f};function b(e){return new(h[e.slice(0,3).toString("hex")]||h[e.slice(0,2).toString("hex")])(e)}},47:function(e,t,n){e.exports={container:"_3Q4jVp-XdRE9lL_y-DHvqZ",table:"_12l9Lp-US87GiC9o0PbHWo",field:"_1BDqlaGx2FzEtv1WMIea58"}},62:function(e,t,n){"use strict";n.r(t);n(49);var r=n(41),a=n.n(r),c=n(0),o=n.n(c),i=n(25),s=n.n(i),l=n(13),u=n(17),d=n(20),f=n(16),m=n(43),h=n(15),b=n(40),p=n(28),v=n(44),E=n.n(v),g=n(45),y=n(11),w=n(12);const j=E()("SENSOR"),O=Object(g.a)(j),S=j("SET_CONNECTED"),C=j("UPDATE_PACKET"),I=O("REQUEST_DEVICE",async()=>y.g.requestDevice()),D=O("CONNECT",async(e,t,n)=>{const{sensor:r}=n();if(!r)return;await r.connect(),t(S(!0)),r.on("disconnected",()=>{t(S(!1))}),r.on("packet",async e=>(e instanceof y.b&&await r.sendCommand(w.a()),t(C(e)))),r.on("failed",e=>{console.log("Block",e.toString("hex").toUpperCase())}),await r.sendCommand(w.e())}),B=O("DISCONNECT",async(e,t,n)=>{const{sensor:r}=n();return null==r?void 0:r.disconnect()}),U=O("SEND_MESSAGE",async(e,t,n)=>{const{sensor:r}=n();return null==r?void 0:r.sendCommand(e)}),x=Object(p.reducerWithInitialState)(null).case(I.async.done,(e,t)=>t.result),N=n(33),T=n(48);var P=Object(p.reducerWithInitialState)({connected:!1,shuttingdown:!1,latest:{currentPm25:0,ozoneEnabled:!1,screenOff:!1},history:[],historyFully:!1}).case(S,(e,t)=>Object(N.a)(e,e=>{t||(e.shuttingdown=!1,e.latest={currentPm25:0,ozoneEnabled:!1,screenOff:!1}),e.connected=t})).case(C,(e,t)=>Object(N.a)(e,e=>{e.shuttingdown=!1,t instanceof y.a?(e.latest.batteryCapacity=t.capacity,e.latest.batteryCharging=t.isCharging):t instanceof y.c?(e.latest.measurementInterval=t.interval,e.latest.measurementIntervalEnabled=t.enabled):t instanceof y.j?e.latest.windSpeed=t.windSpeed:t instanceof y.e?(e.latest.runTime=t.runtime,e.latest.bootTime=t.boottime):t instanceof y.f?(e.latest.pm25=t.pm25,e.latest.recordDate=t.recordDate):t instanceof y.i?e.latest.version=[t.major,t.minor].join("."):t instanceof y.h?e.shuttingdown=!0:"aa08"===t?.constructor?.name?e.latest.ozoneEnabled=!!t.enabled:"aa09"===t?.constructor?.name?e.latest.screenOff=!!t.off:t instanceof y.u?e.latest.currentPm25=t.currentPm25:t instanceof y.b?(e.history.push({pm25:t.pm25,recordDate:t.recordDate}),e.history=T.a.sortedUniqBy(e.history,e=>(null===(t=e.recordDate)||void 0===t?void 0:t.getTime())||0)):t instanceof y.d&&(e.historyFully=!0)}));const _=Object(h.b)(),k=f.d;var A=n(31),M=n.n(A),z=n(84),q=n(85),L=n(86),V=n(87),W=n(88),F=n(90),G=n(89),R=n(47),H=n.n(R);const tryAutoConnect=async(e,t)=>{if(!navigator.bluetooth)return;try{const n=await navigator.bluetooth.getDevices(),r=n.find(e=>e.name&&e.name.includes("MOPS"));if(r&&r.gatt.connected){const n=new y.g(r);e(x.reducer.case(I.async.done,()=>n)),await e(D())}}catch(e){console.log("自动恢复失败",e)}};const getPm25Color=e=>{if(e<=35)return"success";if(e<=75)return"warning";if(e<=115)return"orange";return"danger"};const J=()=>{const e=Object(l.d)(),t=Object(l.e)(e=>e.report.connected),n=Object(l.e)(e=>e.report.shuttingdown),r=Object(l.e)(e=>e.report.latest),a=Object(l.e)(e=>e.sensor),[i,s]=o.a.useState(!1),[u,d]=o.a.useState(null),[f,m]=o.a.useState("");const h=e=>{if(e<=0)return"00:00";const t=Math.ceil(e/1e3),n=Math.floor(t/60).toString().padStart(2,"0"),r=(t%60).toString().padStart(2,"0");return`${n}:${r}`},g=async()=>{if(!t||i)return;if(u&&clearInterval(u),s(!0),m("50:00"),await e(U(w.f(30)));const n=Date.now()+3e6,a=9e5,c=setInterval(async()=>{const o=Date.now(),l=n-o;l>0?m(h(l)):(o-n>=a?(await e(U(w.f(60))),s(!1),m("已完成"),clearInterval(c),d(null),setTimeout(()=>m(""),3e3)):(await e(U(w.f(Math.round(30+30*(o-n)/a)))),m(`升风中 ${h(a-(o-n))}`)))},1e3);d(c)},v=async n=>{if(!t)return;const a=r.windSpeed||0,c=Math.max(0,Math.min(100,a+n));c!==a&&await e(U(w.f(c)))},j=async()=>{const t=!r.ozoneEnabled,n=new Uint8Array([170,22,t?1:0,(170+22+(t?1:0))&255,255]);await e(U(n))},b=async()=>{const t=!r.screenOff,n=new Uint8Array([170,27,t?1:0,(170+27+(t?1:0))&255,255]);await e(U(n))};return o.a.useEffect(()=>{!t&&!a&&tryAutoConnect(e,Object(l.e)),()=>u&&clearInterval(u)},[]),o.a.createElement(z.a,{className:H.a.container},o.a.createElement(q.a,null,o.a.createElement(L.a,null,o.a.createElement(V.a,{color:t?"success":"primary",onClick:async()=>{t?await e(B()):(await e(I()),await e(D()))}},t?"断开连接":"连接设备"),o.a.createElement(V.a,{disabled:!t,color:t?"danger":void 0,onClick:()=>e(U(w.g()))},n?"关机中":"关机"),o.a.createElement(V.a,{disabled:!t||i,color:"success",style:{backgroundColor:i?"#28a745cc":"#28a745",marginLeft:8},onClick:g},"睡眠开始"),i&&o.a.createElement("span",{style:{marginLeft:16,fontWeight:"bold",color:"#28a745",fontSize:"1.2em"}},f||"运行中..."))),o.a.createElement(q.a,null,o.a.createElement("h3",null,"MOPS 忻风随身空气净化器"),o.a.createElement("div",{style:{display:"flex",alignItems:"center",gap:12,flexWrap:"wrap",margin:"20px 0"}},o.a.createElement("strong",null,"调节风量"),o.a.createElement("div",{style:{flex:1,minWidth:300,display:"flex",alignItems:"center",gap:10}},o.a.createElement(V.a,{size:"sm",color:"secondary",disabled:!t,onClick:()=>v(-5),style:{width:50}},"−5%"),o.a.createElement(G.a,{type:"range",min:0,max:100,step:1,value:r.windSpeed??0,disabled:!t,onChange:t=>e(U(w.f(parseInt(t.target.value))))}),o.a.createElement(V.a,{size:"sm",color:"secondary",disabled:!t,onClick:()=>v(5),style:{width:50}},"+5%"))),o.a.createElement(W.a,{responsive:!0},o.a.createElement("tbody",null,o.a.createElement("tr",null,o.a.createElement("td",null,o.a.createElement("strong",null,"当前 PM2.5")),o.a.createElement("td",null,o.a.createElement("strong",{style:{fontSize:"1.4em",color:`var(--bs-${getPm25Color(r.currentPm25)})`}},r.currentPm25!=null?r.currentPm25:"—")," μg/m³ ",r.currentPm25!=null&&o.a.createElement("small",null,r.currentPm25<=35?"(优秀)":r.currentPm25<=75?"(良好)":r.currentPm25<=115?"(轻度污染)":"(中重度污染)"))),o.a.createElement("tr",null,o.a.createElement("td",null,o.a.createElement("strong",null,"电池")),o.a.createElement("td",null,o.a.createElement(F.a,{value:r.batteryCapacity??0},r.batteryCapacity?r.batteryCapacity+"%":"N/A"," ",r.batteryCharging?"(充电中)":"(放电中)"))),o.a.createElement("tr",null,o.a.createElement("td",null,o.a.createElement("strong",null,"当前风量")),o.a.createElement("td",{className:"text-monospace"},r.windSpeed!=null?r.windSpeed+"%":"N/A",i?` (睡眠模式 · ${f})`:"")),o.a.createElement("tr",null,o.a.createElement("td",null,o.a.createElement("strong",null,"运行时间")),o.a.createElement("td",{className:"text-monospace"},r.runTime?M()(1e3*r.runTime):"N/A")),o.a.createElement("tr",null,o.a.createElement("td",null,o.a.createElement("strong",null,"启动时间")),o.a.createElement("td",{className:"text-monospace"},r.bootTime?M()(1e3*r.bootTime):"N/A")),o.a.createElement("tr",null,o.a.createElement("td",null,o.a.createElement("strong",null,"固件版本")),o.a.createElement("td",{className:"text-monospace"},r.version||"N/A")))),o.a.createElement("div",{style:{margin:"24px 0",padding:"16px",backgroundColor:"#f8f9fa",borderRadius:"8px"}},o.a.createElement("h5",{style:{margin:"0 0 12px 0",color:"#333"}},"高级功能"),o.a.createElement("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:12}},o.a.createElement("span",null,o.a.createElement("strong",null,"负离子净化")," (增强除菌除味)"),o.a.createElement(V.a,{color:r.ozoneEnabled?"success":"secondary",outline:!r.ozoneEnabled,disabled:!t,size:"sm",onClick:j},r.ozoneEnabled?"已开启":"已关闭")),o.a.createElement("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"}},o.a.createElement("span",null,o.a.createElement("strong",null,"定时关灯")," (10秒后熄灭面板灯)"),o.a.createElement(V.a,{color:r.screenOff?"danger":"warning",outline:!r.screenOff,disabled:!t,size:"sm",onClick:b},r.screenOff?"已熄灭":"点亮中")))),o.a.createElement(q.a,null,o.a.createElement("p",null,"实时 PM2.5 显示 | 睡眠缓升 | 负离子 | 定时关灯 | 自动重连"),o.a.createElement("p",null,"项目地址：https://github.com/createskyblue/mops_xinfeng"))))};var Q=Object(f.e)(($=_,Object(f.c)({router:Object(d.b)($),sensor:x,report:P})),void 0,k(Object(f.a)(Object(b.a)(_),m.a)));var $;const K=()=>o.a.createElement(l.a,{store:Q},o.a.createElement(d.a,{history:_},o.a.createElement(u.c,null,o.a.createElement(u.a,{exact:!0,path:"/",component:J}))));a()(()=>{const e=document.createElement("main");document.body=document.createElement("body"),document.body.appendChild(e),s.a.render(o.a.createElement(K),e)})}});
//# sourceMappingURL=main.js.map